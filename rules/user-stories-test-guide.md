# 用户故事和测试指南规范

本文档定义了如何编写用户故事文档以及如何为用户故事编写测试用例。

## 用户故事定义

**核心概念：用户故事代表用户在系统中完成某个目标的一连串行为。**

### 用户故事的特点

1. **以用户为中心**：描述用户想要完成什么
2. **行为导向**：描述用户的具体操作步骤
3. **价值驱动**：每个行为都应该为用户创造价值
4. **可测试性**：每个行为都可以通过接口调用进行验证

---

## 用户故事与接口的关系

### 核心规则：每个用户行为对应一个接口

**原则：** 将用户的完整操作流程拆分为独立的行为步骤，每个步骤对应一个 API 接口调用。

### 示例：用户登录流程

#### 用户故事描述

> 作为一个用户，我想要登录系统，以便我可以访问我的个人信息和使用系统功能。

#### 行为拆分

| 步骤 | 用户行为 | 对应接口 | HTTP 方法 |
|------|----------|----------|-----------|
| 1 | 输入用户名和密码 | `/api/auth/login` | POST |
| 2 | 获取个人信息 | `/api/users/me` | GET |

### 示例：发布文章流程

#### 用户故事描述

> 作为一个作者，我想要发布一篇文章，以便我可以分享我的观点并获得读者反馈。

#### 行为拆分

| 步骤 | 用户行为 | 对应接口 | HTTP 方法 |
|------|----------|----------|-----------|
| 1 | 创建文章草稿 | `/api/posts` | POST |
| 2 | 上传文章封面图 | `/api/posts/{id}/cover` | POST |
| 3 | 发布文章 | `/api/posts/{id}/publish` | POST |
| 4 | 获取发布后的文章 | `/api/posts/{id}` | GET |

---

## 文档格式规范

### 用户故事文档模板

```markdown
# [用户故事标题]

## 用户角色
[描述使用此功能的用户角色]

## 用户目标
[描述用户想要达成的目标]

## 行为流程

### 行为 1：[行为标题]
**描述：** [描述用户的具体行为]
**接口：** `[接口路径]`
**请求方式：** `[HTTP 方法]`

### 行为 2：[行为标题]
**描述：** [描述用户的具体行为]
**接口：** `[接口路径]`
**请求方式：** `[HTTP 方法]`

## 测试用例
[参考测试用例部分]
```

### 测试用例文档模板

每个行为都应该包含以下测试信息：

#### 1. cURL 请求示例

```bash
curl -X [HTTP 方法] \
  'http://api.example.com[接口路径]' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer {token}' \
  -d '{
    [请求体参数]
  }'
```

#### 2. 预期响应

**成功响应：**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    [响应数据]
  }
}
```

**失败响应示例：**
```json
{
  "code": 400,
  "message": "错误描述",
  "data": null
}
```

#### 3. 测试场景

| 场景描述 | 请求参数 | 预期结果 |
|----------|----------|----------|
| 正常场景 | [正常参数] | 返回成功响应 |
| 参数缺失 | [缺失必要参数] | 返回 400 错误 |
| 权限不足 | [无权限的 token] | 返回 401/403 错误 |
| 资源不存在 | [不存在的资源 ID] | 返回 404 错误 |

---

## 完整示例

### 用户故事：用户注册和激活

#### 用户角色
新用户

#### 用户目标
注册一个新账户并激活，以便可以使用系统的全部功能。

#### 行为流程

##### 行为 1：提交注册信息
**描述：** 用户填写注册表单，提交用户名、邮箱和密码

**接口：** `/api/auth/register`
**请求方式：** POST

**cURL 请求：**
```bash
curl -X POST \
  'http://api.example.com/api/auth/register' \
  -H 'Content-Type: application/json' \
  -d '{
    "username": "john_doe",
    "email": "john@example.com",
    "password": "SecurePass123!"
  }'
```

**预期响应（成功）：**
```json
{
  "code": 201,
  "message": "注册成功，请查收验证邮件",
  "data": {
    "userId": "12345",
    "username": "john_doe",
    "email": "john@example.com",
    "status": "pending_activation",
    "createdAt": "2026-02-08T10:30:00Z"
  }
}
```

**预期响应（邮箱已存在）：**
```json
{
  "code": 409,
  "message": "该邮箱已被注册",
  "data": null
}
```

**测试场景：**
| 场景描述 | 请求参数 | 预期结果 |
|----------|----------|----------|
| 正常注册 | 完整且有效的注册信息 | 返回 201，创建用户 |
| 邮箱重复 | 已存在的邮箱 | 返回 409 错误 |
| 密码过弱 | 密码少于 8 位 | 返回 400 错误 |
| 用户名重复 | 已存在的用户名 | 返回 409 错误 |

---

##### 行为 2：激活账户
**描述：** 用户点击邮件中的激活链接，完成账户激活

**接口：** `/api/auth/activate`
**请求方式：** POST

**cURL 请求：**
```bash
curl -X POST \
  'http://api.example.com/api/auth/activate' \
  -H 'Content-Type: application/json' \
  -d '{
    "token": "activation_token_from_email"
  }'
```

**预期响应（成功）：**
```json
{
  "code": 200,
  "message": "账户激活成功",
  "data": {
    "userId": "12345",
    "status": "active",
    "activatedAt": "2026-02-08T10:35:00Z"
  }
}
```

**预期响应（token 无效）：**
```json
{
  "code": 400,
  "message": "激活链接无效或已过期",
  "data": null
}
```

**测试场景：**
| 场景描述 | 请求参数 | 预期结果 |
|----------|----------|----------|
| 正常激活 | 有效的激活 token | 返回 200，账户状态变为 active |
| token 无效 | 错误或过期的 token | 返回 400 错误 |
| 重复激活 | 已激活的账户 token | 返回 400 错误 |

---

##### 行为 3：激活后登录
**描述：** 账户激活后，用户使用邮箱和密码登录

**接口：** `/api/auth/login`
**请求方式：** POST

**cURL 请求：**
```bash
curl -X POST \
  'http://api.example.com/api/auth/login' \
  -H 'Content-Type: application/json' \
  -d '{
    "email": "john@example.com",
    "password": "SecurePass123!"
  }'
```

**预期响应（成功）：**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refreshToken": "refresh_token_value",
    "user": {
      "id": "12345",
      "username": "john_doe",
      "email": "john@example.com"
    }
  }
}
```

**预期响应（未激活账户登录）：**
```json
{
  "code": 403,
  "message": "账户未激活，请先激活账户",
  "data": null
}
```

**测试场景：**
| 场景描述 | 请求参数 | 预期结果 |
|----------|----------|----------|
| 正常登录 | 正确的邮箱和密码 | 返回 200，包含 token |
| 密码错误 | 错误的密码 | 返回 401 错误 |
| 未激活登录 | 未激活的账户 | 返回 403 错误 |
| 账户不存在 | 不存在的邮箱 | 返回 404 错误 |

---

## 编写指南

### 1. 用户行为拆分原则

- **原子性**：每个行为应该是原子的，不可再分
- **独立性**：每个行为可以独立测试
- **顺序性**：行为之间有明确的先后顺序
- **完整性**：所有行为组合起来完成完整的用户目标

### 2. 接口命名参考

遵循 [Web 接口命名规范](./web-api-naming-convention.md)：
- 路径参数最多一个，位于路由末尾
- 使用语义化的 HTTP 方法
- 路由 + HTTP 方法直接表达含义

### 3. 测试用例编写要点

- **覆盖正常场景**：最常见的使用情况
- **覆盖异常场景**：各种错误情况
- **边界条件**：参数为空、极值等
- **权限验证**：不同权限级别的访问
- **并发场景**（如适用）：重复提交等

### 4. 响应格式建议

统一使用以下响应格式：

```json
{
  "code": 200,          // 业务状态码
  "message": "success", // 描述信息
  "data": {             // 实际数据
    // ...
  },
  "timestamp": "2026-02-08T10:30:00Z" // 时间戳（可选）
}
```

---

## 测试执行清单

在进行测试时，请按以下清单执行：

### 准备阶段
- [ ] 确认测试环境已就绪
- [ ] 准备测试数据
- [ ] 获取测试用的认证 token（如需要）

### 执行阶段
- [ ] 按照用户故事的顺序执行每个行为
- [ ] 记录每个接口的响应时间
- [ ] 捕获响应数据用于后续行为
- [ ] 测试所有列出的测试场景

### 验证阶段
- [ ] 验证响应状态码是否正确
- [ ] 验证响应数据结构是否符合预期
- [ ] 验证业务逻辑是否正确
- [ ] 验证错误处理是否合理

### 文档阶段
- [ ] 记录测试结果
- [ ] 记录发现的问题
- [ ] 更新测试用例（如有必要）

---

## 常见问题

### Q1: 如果一个用户行为需要调用多个接口怎么办？

**A:** 重新审视行为拆分，确保每个行为是原子的。如果确实需要多个接口，考虑：
- 是否可以将多个接口合并为一个
- 或者将行为进一步拆分为更细粒度的步骤

### Q2: 如何处理需要后端处理的异步操作？

**A:** 在文档中明确说明：
- 操作是异步的
- 如何查询操作状态（提供一个状态查询接口）
- 预期的完成时间范围

### Q3: 测试用例需要覆盖所有可能的错误场景吗？

**A:** 优先覆盖：
- 最常见的错误场景
- 业务逻辑上重要的错误场景
- 安全相关的错误场景

其他边缘场景可以根据时间和资源选择性覆盖。

---

## 相关文档

- [Web 接口命名规范](./web-api-naming-convention.md)
- [REST API 测试最佳实践](https://api.slack.com/docs/rate-limits)
